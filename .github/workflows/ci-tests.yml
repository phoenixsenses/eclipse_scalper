name: CI Tests

on:
  pull_request:
  push:
    branches:
      - "**"
  workflow_dispatch:
  schedule:
    - cron: "20 3 * * *"

jobs:
  chaos-required:
    name: Chaos Required - ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ack-after-fill-recovery
            cmd: pytest -q tools/test_execution_chaos_scenarios.py -k router_recovers_timeout_and_duplicate_then_returns_partial_fill
          - name: cancel-unknown-idempotent
            cmd: pytest -q tools/test_execution_chaos_scenarios.py -k cancel_after_fill_unknown_order_is_idempotent_success
          - name: replace-race-single-exposure
            cmd: pytest -q tools/test_execution_chaos_scenarios_v2.py -k crash_mid_replace_filled_after_cancel_rebuild_reconcile_stays_single_exposure

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run required chaos scenario
        run: ${{ matrix.cmd }}

  execution-invariants:
    name: Execution Invariants and Gate
    runs-on: ubuntu-latest
    needs: chaos-required

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run execution invariant suite
        run: |
          pytest -q tools/test_state_machine_unit.py
          pytest -q tools/test_belief_controller_unit.py
          pytest -q tools/test_order_router_unit.py
          pytest -q tools/test_replace_manager_unit.py
          pytest -q tools/test_intent_ledger_unit.py
          pytest -q tools/test_protection_manager_unit.py
          pytest -q tools/test_reliability_gate_unit.py
          pytest -q tools/test_reliability_gate_runtime_unit.py
          pytest -q tools/test_telemetry_alert_summary_unit.py
          pytest -q tools/test_telemetry_dashboard_notify_unit.py
          pytest -q tools/test_telemetry_belief_state_unit.py
          pytest -q tools/test_telemetry_workflow_flags_unit.py

      - name: Enforce reliability gate thresholds on synthetic fixture
        run: |
          mkdir -p logs
          python - <<'PY'
          import json
          from pathlib import Path
          tele = [
              {"event": "order.retry", "data": {"correlation_id": "CID-GATE-1"}},
          ]
          journ = [
              {
                  "event": "state.transition",
                  "data": {
                      "machine": "order_intent",
                      "state_from": "INTENT_CREATED",
                      "state_to": "SUBMITTED",
                      "correlation_id": "CID-GATE-1",
                  },
              }
          ]
          Path("logs/telemetry_gate_fixture.jsonl").write_text(
              "\n".join(json.dumps(x) for x in tele) + "\n",
              encoding="utf-8",
          )
          Path("logs/journal_gate_fixture.jsonl").write_text(
              "\n".join(json.dumps(x) for x in journ) + "\n",
              encoding="utf-8",
          )
          PY
          python tools/reliability_gate.py \
            --telemetry logs/telemetry_gate_fixture.jsonl \
            --journal logs/journal_gate_fixture.jsonl \
            --output logs/reliability_gate_ci.txt \
            --max-replay-mismatch 0 \
            --max-invalid-transitions 0 \
            --min-journal-coverage 1.0 \
            --enforce

      - name: Verify reliability gate degrades on missing journal coverage
        run: |
          mkdir -p logs
          python - <<'PY'
          import json
          from pathlib import Path
          tele = [
              {"event": "order.retry", "data": {"correlation_id": "CID-GATE-MISS"}},
          ]
          journ = []
          Path("logs/telemetry_gate_missing_fixture.jsonl").write_text(
              "\n".join(json.dumps(x) for x in tele) + "\n",
              encoding="utf-8",
          )
          Path("logs/journal_gate_missing_fixture.jsonl").write_text(
              "\n".join(json.dumps(x) for x in journ) + ("\n" if journ else ""),
              encoding="utf-8",
          )
          PY
          set +e
          python tools/reliability_gate.py \
            --telemetry logs/telemetry_gate_missing_fixture.jsonl \
            --journal logs/journal_gate_missing_fixture.jsonl \
            --output logs/reliability_gate_ci_missing.txt \
            --max-replay-mismatch 0 \
            --max-invalid-transitions 0 \
            --min-journal-coverage 1.0 \
            --enforce
          rc=$?
          set -e
          test "$rc" -ne 0

      - name: Upload gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-reliability-gate-artifacts
          path: |
            logs/reliability_gate_ci.txt
            logs/reliability_gate_ci_missing.txt
            logs/telemetry_gate_fixture.jsonl
            logs/journal_gate_fixture.jsonl
            logs/telemetry_gate_missing_fixture.jsonl
            logs/journal_gate_missing_fixture.jsonl

  chaos-nightly:
    name: Chaos Full Suites (Nightly)
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run full chaos suites
        run: |
          pytest -q tools/test_execution_chaos_scenarios.py
          pytest -q tools/test_execution_chaos_scenarios_v2.py

name: Telemetry Smoke Assertions

on:
  schedule:
    - cron: "30 3 * * *"
  workflow_dispatch:

jobs:
  smoke:
    name: Notifier smoke chain
    runs-on: ubuntu-latest
    env:
      CORR_STRESS_THRESHOLD: "1"
      CORR_PRESSURE_THRESHOLD: "0.90"
      CORR_EXIT_PNL_DROP_THRESHOLD: "0.10"
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install runtime dependency
        run: |
          python -m pip install --upgrade pip
          python -m pip install python-telegram-bot==22.5

      - name: Run chained smoke assertions
        run: |
          mkdir -p logs
          rm -f logs/telemetry.jsonl logs/telemetry_dashboard_notify_state.json logs/telemetry_smoke_result.txt

          echo "telemetry smoke chain started" > logs/telemetry_smoke_result.txt

          python - <<'PY'
          import json
          from pathlib import Path
          state = {"recovery_red_lock_streak": 1, "level": "normal"}
          p = Path("logs/telemetry_dashboard_notify_state.json")
          p.write_text(json.dumps(state, ensure_ascii=True, indent=2) + "\n", encoding="utf-8")
          print("seeded state for escalation")
          PY

          python - <<'PY'
          import json, time
          from pathlib import Path
          p = Path("logs/telemetry.jsonl")
          event = {
              "event": "execution.belief_state",
              "ts": float(time.time()),
              "data": {
                  "guard_recovery_stage": "RED_LOCK",
                  "guard_unlock_conditions": "smoke: escalation path",
                  "guard_next_unlock_sec": 300.0,
              },
          }
          with p.open("a", encoding="utf-8") as fh:
              fh.write(json.dumps(event, ensure_ascii=True) + "\n")
          print("injected RED_LOCK event")
          PY

          python tools/telemetry_dashboard_notify.py \
            --path logs/telemetry.jsonl \
            --state-path logs/telemetry_dashboard_notify_state.json \
            --recovery-red-lock-critical-streak 2 \
            --corr-stress-threshold ${CORR_STRESS_THRESHOLD} \
            --corr-pressure-threshold ${CORR_PRESSURE_THRESHOLD} \
            --corr-exit-pnl-drop-threshold ${CORR_EXIT_PNL_DROP_THRESHOLD} \
            --no-notify

          python tools/telemetry_smoke_assert.py \
            --state logs/telemetry_dashboard_notify_state.json \
            --expected-level critical \
            --expected-stage RED_LOCK \
            --expected-red-lock-streak 2 \
            --require-unlock-fields

          echo "phase1=PASS escalation" >> logs/telemetry_smoke_result.txt

          python - <<'PY'
          import json, time
          from pathlib import Path
          p = Path("logs/telemetry.jsonl")
          event = {
              "event": "execution.belief_state",
              "ts": float(time.time()),
              "data": {
                  "guard_recovery_stage": "POST_RED_WARMUP",
                  "guard_unlock_conditions": "smoke: reset path",
                  "guard_next_unlock_sec": 120.0,
              },
          }
          with p.open("a", encoding="utf-8") as fh:
              fh.write(json.dumps(event, ensure_ascii=True) + "\n")
          print("injected POST_RED_WARMUP event")
          PY

          python tools/telemetry_dashboard_notify.py \
            --path logs/telemetry.jsonl \
            --state-path logs/telemetry_dashboard_notify_state.json \
            --recovery-red-lock-critical-streak 2 \
            --corr-stress-threshold ${CORR_STRESS_THRESHOLD} \
            --corr-pressure-threshold ${CORR_PRESSURE_THRESHOLD} \
            --corr-exit-pnl-drop-threshold ${CORR_EXIT_PNL_DROP_THRESHOLD} \
            --no-notify

          python tools/telemetry_smoke_assert.py \
            --state logs/telemetry_dashboard_notify_state.json \
            --expected-level normal \
            --expected-stage POST_RED_WARMUP \
            --expected-red-lock-streak 0 \
            --require-unlock-fields

          python - <<'PY'
          import json, time
          from pathlib import Path
          p = Path("logs/telemetry.jsonl")
          now = float(time.time())
          rows = [
              {
                  "event": "reconcile.summary",
                  "ts": now,
                  "data": {
                      "protection_refresh_budget_blocked_count": 2,
                      "protection_refresh_budget_force_override_count": 1,
                      "protection_refresh_stop_budget_blocked_count": 2,
                  },
              },
              {
                  "event": "execution.belief_state",
                  "ts": now + 0.1,
                  "data": {
                      "guard_recovery_stage": "RUNTIME_GATE_DEGRADED",
                      "allow_entries": False,
                      "trace": {
                          "reason": "runtime_gate_degraded | protection_refresh_budget_hard_block",
                      },
                  },
              },
          ]
          with p.open("a", encoding="utf-8") as fh:
              for ev in rows:
                  fh.write(json.dumps(ev, ensure_ascii=True) + "\n")
          print("injected refresh-budget clamp events")
          PY

          python tools/telemetry_dashboard_notify.py \
            --path logs/telemetry.jsonl \
            --state-path logs/telemetry_dashboard_notify_state.json \
            --recovery-red-lock-critical-streak 2 \
            --corr-stress-threshold ${CORR_STRESS_THRESHOLD} \
            --corr-pressure-threshold ${CORR_PRESSURE_THRESHOLD} \
            --corr-exit-pnl-drop-threshold ${CORR_EXIT_PNL_DROP_THRESHOLD} \
            --protection-refresh-budget-blocked-critical-threshold 2 \
            --protection-refresh-force-override-critical-threshold 2 \
            --no-notify

          python tools/telemetry_smoke_assert.py \
            --state logs/telemetry_dashboard_notify_state.json \
            --min-refresh-budget-blocked 2 \
            --require-entry-clamped-on-refresh-budget \
            --require-refresh-consistency \
            --require-unlock-fields

          python - <<'PY'
          import json, time
          from pathlib import Path
          p = Path("logs/telemetry.jsonl")
          now = float(time.time())
          rows = [
              {
                  "event": "reconcile.summary",
                  "ts": now,
                  "data": {
                      "protection_refresh_budget_blocked_count": 0,
                      "protection_refresh_budget_force_override_count": 0,
                  },
              },
              {
                  "event": "execution.belief_state",
                  "ts": now + 0.1,
                  "data": {
                      "guard_recovery_stage": "PROTECTION_REFRESH_WARMUP",
                      "allow_entries": True,
                      "trace": {
                          "reason": "protection_refresh_budget_warmup",
                      },
                  },
              },
              {
                  "event": "execution.belief_state",
                  "ts": now + 0.2,
                  "data": {
                      "guard_recovery_stage": "GREEN",
                      "allow_entries": True,
                      "trace": {
                          "reason": "stable",
                      },
                  },
              },
          ]
          with p.open("a", encoding="utf-8") as fh:
              for ev in rows:
                  fh.write(json.dumps(ev, ensure_ascii=True) + "\n")
          print("injected refresh-budget release events")
          PY

          python tools/telemetry_dashboard_notify.py \
            --path logs/telemetry.jsonl \
            --state-path logs/telemetry_dashboard_notify_state.json \
            --recovery-red-lock-critical-streak 2 \
            --corr-stress-threshold ${CORR_STRESS_THRESHOLD} \
            --corr-pressure-threshold ${CORR_PRESSURE_THRESHOLD} \
            --corr-exit-pnl-drop-threshold ${CORR_EXIT_PNL_DROP_THRESHOLD} \
            --protection-refresh-budget-blocked-critical-threshold 2 \
            --protection-refresh-force-override-critical-threshold 2 \
            --no-notify

          python tools/telemetry_smoke_assert.py \
            --state logs/telemetry_dashboard_notify_state.json \
            --expected-level normal \
            --expected-stage GREEN \
            --require-unlock-fields

          echo "phase2=PASS reset" >> logs/telemetry_smoke_result.txt
          python - <<'PY'
          import json
          from pathlib import Path
          state = json.loads(Path("logs/telemetry_dashboard_notify_state.json").read_text(encoding="utf-8"))
          with Path("logs/telemetry_smoke_result.txt").open("a", encoding="utf-8") as fh:
              fh.write(f"level={state.get('level')}\n")
              fh.write(f"recovery_stage_latest={state.get('recovery_stage_latest')}\n")
              fh.write(f"recovery_red_lock_streak={state.get('recovery_red_lock_streak')}\n")
              fh.write(f"last_decision_reason={state.get('last_decision_reason')}\n")
          print("wrote telemetry_smoke_result.txt")
          PY

      - name: Upload smoke artifacts
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-smoke
          path: |
            logs/telemetry_smoke_result.txt
            logs/telemetry_dashboard_notify_state.json
            logs/telemetry.jsonl

name: Telemetry Dashboard Snapshot

on:
  schedule:
    # every 6 hours to keep the snapshot fresh
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      simulate_red_lock_event:
        description: "Inject a synthetic RED_LOCK belief-state event for notifier smoke testing"
        required: false
        default: "false"
      simulate_recovery_stage_override:
        description: "Inject this guard_recovery_stage value (e.g. POST_RED_WARMUP) for reset-path smoke tests"
        required: false
        default: ""
      expected_notifier_level:
        description: "Optional smoke assertion: expected notifier level (normal/critical)"
        required: false
        default: ""
      expected_recovery_stage:
        description: "Optional smoke assertion: expected recovery stage value"
        required: false
        default: ""
      expected_red_lock_streak:
        description: "Optional smoke assertion: expected recovery_red_lock_streak value"
        required: false
        default: ""
      simulate_red_lock_seed_streak:
        description: "Optional prior RED_LOCK streak seed (e.g. 1 with threshold=2 to force critical)"
        required: false
        default: "0"

jobs:
  snapshot:
    name: Dashboard snapshot
    runs-on: ubuntu-latest
    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEMETRY_DASHBOARD_NOTIFY_STATE_PATH: logs/telemetry_dashboard_notify_state.json
      RECOVERY_RED_LOCK_CRITICAL_STREAK: "2"
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Ensure logs directory
        run: mkdir -p logs

      - name: Restore notifier state cache
        id: notify_state_restore
        uses: actions/cache/restore@v4
        with:
          path: logs/telemetry_dashboard_notify_state.json
          key: telemetry-notify-state-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            telemetry-notify-state-${{ github.ref_name }}-

      - name: Seed notifier state for recovery smoke
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          SHOULD_SEED=false
          if [ "${{ github.event.inputs.simulate_red_lock_seed_streak }}" != "0" ]; then
            if [ "${{ github.event.inputs.simulate_red_lock_event }}" = "true" ] || [ -n "${{ github.event.inputs.simulate_recovery_stage_override }}" ]; then
              SHOULD_SEED=true
            fi
          fi
          if [ "$SHOULD_SEED" != "true" ]; then
            echo "seed skipped"
            exit 0
          fi
          python - <<'PY'
          import json
          from pathlib import Path
          p = Path("logs/telemetry_dashboard_notify_state.json")
          data = {}
          if p.exists():
            try:
              data = json.loads(p.read_text(encoding="utf-8"))
            except Exception:
              data = {}
          seed = int("${{ github.event.inputs.simulate_red_lock_seed_streak }}")
          data["recovery_red_lock_streak"] = max(int(data.get("recovery_red_lock_streak", 0) or 0), seed)
          p.write_text(json.dumps(data, ensure_ascii=True, indent=2) + "\n", encoding="utf-8")
          print(f"seeded notifier state recovery_red_lock_streak={data['recovery_red_lock_streak']}")
          PY

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install python-telegram-bot==22.5

      - name: Build reliability gate summary
        run: |
          python tools/reliability_gate.py \
            --telemetry logs/telemetry.jsonl \
            --journal logs/execution_journal.jsonl \
            --output logs/reliability_gate.txt \
            --allow-missing

      - name: Inject recovery-stage smoke event
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          STAGE="${{ github.event.inputs.simulate_recovery_stage_override }}"
          if [ -z "$STAGE" ] && [ "${{ github.event.inputs.simulate_red_lock_event }}" = "true" ]; then
            STAGE="RED_LOCK"
          fi
          if [ -z "$STAGE" ]; then
            echo "recovery-stage smoke skipped"
            exit 0
          fi
          export STAGE
          python - <<'PY'
          import json, os, time
          from pathlib import Path
          stage = str(os.getenv("STAGE") or "").strip() or "RED_LOCK"
          p = Path("logs/telemetry.jsonl")
          payload = {
            "event": "execution.belief_state",
            "ts": float(time.time()),
            "data": {
              "guard_recovery_stage": stage,
              "guard_unlock_conditions": f"smoke: injected {stage} event",
              "guard_next_unlock_sec": 300.0,
            },
          }
          p.parent.mkdir(parents=True, exist_ok=True)
          with p.open("a", encoding="utf-8") as fh:
            fh.write(json.dumps(payload, ensure_ascii=True) + "\n")
          print(f"injected {stage} belief-state smoke event")
          PY

      - name: Run telemetry dashboard notifier
        run: >
          python tools/telemetry_dashboard_notify.py
          --path logs/telemetry.jsonl
          --codes-per-symbol
          --codes-top 4
          --guard-events
          --guard-history
          --guard-history-path logs/telemetry_guard_history.csv
          --reliability-gate logs/reliability_gate.txt
          --reliability-max-replay-mismatch 0
          --reliability-max-invalid-transitions 0
          --reliability-min-journal-coverage 0.90
          --reconcile-first-gate-critical-threshold 2
          --reconcile-first-gate-severity-threshold 0.85
          --reconcile-first-gate-severity-streak-threshold 2
          --recovery-red-lock-critical-streak ${RECOVERY_RED_LOCK_CRITICAL_STREAK}
          --entry-budget-depleted-critical-threshold 2
          --replace-envelope-critical-threshold 2

      - name: Run telemetry classifier
        run: >
          python tools/telemetry_classifier.py
          --path logs/telemetry.jsonl
          --since-min 60
      - name: Run signal data health report
        run: |
          python tools/signal_data_health.py --path logs/telemetry.jsonl --since-min 60 > logs/signal_data_health.txt
      - name: Run core health dashboard
        run: |
          python tools/core_health.py --path logs/telemetry.jsonl --since-min 60 --limit 2000 > logs/core_health.txt
      - name: Run telemetry anomaly detector
        run: |
          python tools/telemetry_anomaly.py --path logs/telemetry.jsonl --since-min 60 --output logs/telemetry_anomaly.txt
      - name: Run telemetry drift detection
        run: |
          python tools/telemetry_drift_detection.py \
            --path logs/telemetry.jsonl \
            --since-min 60 \
            --min-count 6 \
            --zscore 2.5 \
            --emit-event \
            --event-path logs/telemetry_drift.jsonl \
            --summary logs/telemetry_drift_summary.txt
      - name: Run signal exit telemetry notifier
        run: |
          python tools/telemetry_signal_exit_notify.py \
            --path logs/telemetry.jsonl \
            --since-min 60 \
            --emit-event \
            --summary logs/signal_exit_notify.txt \
            --issue-ratio 0.25 \
            --issue-count 2 \
            --recovery-min-confidence 0.7 \
            --recovery-duration 600
      - name: Run telemetry guard timeline
        run: |
          python tools/telemetry_guard_timeline.py \
            --path logs/telemetry.jsonl \
            --state logs/telemetry_adaptive_guard.json \
            --since-min 180 \
            --notify
      - name: Build guard history table
        run: |
          python tools/telemetry_guard_history.py \
            --drift-summary logs/telemetry_drift_summary.txt \
            --signal-exit logs/signal_exit_notify.txt \
            --guard-timeline logs/telemetry_guard_timeline.txt \
            --output-csv logs/telemetry_guard_history.csv \
            --output-html logs/telemetry_guard_history.html \
            --limit 48
      - name: Run telemetry dashboard summary
        run: |
          python tools/telemetry_dashboard.py \
            --path logs/telemetry.jsonl \
            --limit 1000 \
            --guard-events \
            --guard-history \
            --guard-history-path logs/telemetry_guard_history.csv
      - name: Guard history alerts
        run: |
          python tools/telemetry_guard_history_alerts.py \
            --path logs/telemetry_guard_history.csv \
            --window 8 \
            --threshold 3 \
            --hit-rate 0.25 \
            --notify
      - name: Defense posture summary
        run: |
          python tools/defense_system.py \
            --history logs/telemetry_guard_history.csv \
            --rows 16 \
            --actions logs/telemetry_anomaly_actions.json \
            --timeline logs/telemetry_guard_timeline.txt \
            --notify
      - name: Generate telemetry dashboard page
        run: |
          python tools/telemetry_dashboard_page.py \
            --core logs/core_health.txt \
            --signal logs/signal_data_health.txt \
            --anomaly logs/telemetry_anomaly.txt \
            --reliability-gate logs/reliability_gate.txt \
            --output logs/telemetry_dashboard_page.html
      - name: Summarize telemetry alert artifacts
        run: |
          python tools/telemetry_alert_summary.py \
            --signal logs/signal_data_health.txt \
            --core logs/core_health.txt \
            --anomaly logs/telemetry_anomaly.txt \
            --signal-exit logs/signal_exit_notify.txt \
            --telemetry logs/telemetry.jsonl \
            --output logs/telemetry_alert_summary.txt
      - name: Build latest replay summary
        run: |
          if [ -f tools/replay_latest_summary.py ]; then
            python tools/replay_latest_summary.py \
              --telemetry logs/telemetry.jsonl \
              --journal logs/execution_journal.jsonl \
              --output logs/replay_latest.txt \
              --limit 10
          else
            echo "replay_latest_summary.py not present; skipping replay summary" > logs/replay_latest.txt
          fi

      - name: Inspect notifier state
        run: |
          if [ -f logs/telemetry_dashboard_notify_state.json ]; then
            python -c "import json; from pathlib import Path; p=Path('logs/telemetry_dashboard_notify_state.json'); d=json.loads(p.read_text(encoding='utf-8')); print('notifier_state:'); [print(f'- {k}={d.get(k)}') for k in ('level','recovery_stage_latest','recovery_red_lock_streak','last_decision_reason','last_decision_sent')]"
          else
            echo "notifier_state: missing"
          fi

      - name: Assert smoke notifier expectations
        if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.expected_notifier_level != '' || github.event.inputs.expected_recovery_stage != '' || github.event.inputs.expected_red_lock_streak != '') }}
        run: |
          python tools/telemetry_smoke_assert.py \
            --state logs/telemetry_dashboard_notify_state.json \
            --expected-level "${{ github.event.inputs.expected_notifier_level }}" \
            --expected-stage "${{ github.event.inputs.expected_recovery_stage }}" \
            --expected-red-lock-streak "${{ github.event.inputs.expected_red_lock_streak }}"

      - name: Save notifier state cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: logs/telemetry_dashboard_notify_state.json
          key: telemetry-notify-state-${{ github.ref_name }}-${{ github.run_id }}

      - name: Upload telemetry artifacts
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-snapshots
          path: |
            logs/telemetry_health.html
            logs/signal_data_health.txt
            logs/core_health.txt
            logs/telemetry_anomaly.txt
            logs/telemetry_dashboard_page.html
            logs/telemetry_alert_summary.txt
            logs/telemetry_anomaly.txt
            logs/telemetry_guard_timeline.html
            logs/telemetry_guard_timeline.txt
            logs/telemetry_guard_history.csv
            logs/telemetry_guard_history.html
            logs/telemetry_drift_summary.txt
            logs/signal_exit_notify.txt
            logs/replay_latest.txt
            logs/reliability_gate.txt
            logs/telemetry_dashboard_notify_state.json
